From 5612f5ed93d98493d6bc997b87b6be52e7762973 Mon Sep 17 00:00:00 2001
From: Felix Huettner <felix.huettner@stackit.cloud>
Date: Wed, 18 Dec 2024 11:25:03 +0100
Subject: [Patch ovn 06/15] northd: Sync routing data to pb.
To: dev@openvswitch.org

this allows the the ovn-controller to later find all ports that
participate in dynamic routing.

Signed-off-by: Felix Huettner <felix.huettner@stackit.cloud>
---
 northd/northd.c | 15 +++++++++++++++
 ovn-nb.xml      | 23 +++++++++++++++++++++++
 2 files changed, 38 insertions(+)

diff --git a/northd/northd.c b/northd/northd.c
index ee00f990e..5a4f24956 100644
--- a/northd/northd.c
+++ b/northd/northd.c
@@ -4062,6 +4062,21 @@ sync_pb_for_lrp(struct ovn_port *op,
         }
     }
 
+    if (is_cr_port(op) || chassis_name) {
+        if (smap_get_bool(&op->nbrp->options, "maintain-vrf", false)) {
+            smap_add(&new, "maintain-vrf", "true");
+        }
+        if (smap_get_bool(&op->od->nbr->options, "dynamic-routing", false)) {
+            smap_add(&new, "dynamic-routing", "true");
+        }
+        const char *ifname = smap_get(&op->nbrp->options,
+                                      "dynamic-routing-ifname");
+        if (ifname) {
+            smap_add(&new, "dynamic-routing-ifname", ifname);
+        }
+    }
+
+
     const char *ipv6_pd_list = smap_get(&op->sb->options, "ipv6_ra_pd_list");
     if (ipv6_pd_list) {
         smap_add(&new, "ipv6_ra_pd_list", ipv6_pd_list);
diff --git a/ovn-nb.xml b/ovn-nb.xml
index 268e6d041..1f298f159 100644
--- a/ovn-nb.xml
+++ b/ovn-nb.xml
@@ -3775,6 +3775,29 @@ or
           </li>
         </ul>
       </column>
+
+      <column name="options" key="maintain-vrf" type='{"type": "boolean"}'>
+        Only relevant if <ref column="options" key="dynamic-routing"
+        table="Logical_Router"/> on the respective Logical_Router is set
+          to <code>true</code>.
+
+          If this LRP is bound to a specific chassis then the ovn-controller of
+          this chassis will maintain a vrf named "ovnvrf" with the datapath id
+          of the Logical Router appended to it.
+          This vrf will contain all the routes that should be announced from
+          this LRP.
+      </column>
+
+      <column name="options" key="dynamic-routing-ifname"
+          type='{"type": "string"}'>
+        Only relevant if <ref column="options" key="dynamic-routing"
+        table="Logical_Router"/> on the respective Logical_Router is set
+          to <code>true</code>.
+
+          Only learn routes associated with the interface specified here.
+          This allows a single chassis to learn different routes on separate
+          LRPs bound to this chassis.
+      </column>
     </group>
 
     <group title="Attachment">
-- 
2.43.0

